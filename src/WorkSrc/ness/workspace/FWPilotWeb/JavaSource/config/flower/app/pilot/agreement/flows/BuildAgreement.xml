<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root SYSTEM "flower.dtd">
<root>

	<buttonSet name="buildHeskemButtons">
		<button name="save" eventName="save" group="left" stateModelId="agreementDisplayStateModel" />
		<button name="close" eventName="close" group="left" activityType="readOnly" checkDirtyFlag="true"/>
	</buttonSet>

	<context name="validateCustomerContext">
		<field name="id"  childAccess="full" type="xiString"/>
	</context>
	
	<formatterDefinition name="validateCustomerFormatter" type="simple">
		<format fromName="customerId" toName="id"/>
	</formatterDefinition>

 	<flow name="buildAgreementFlow" context="AgreementCTX"> 
  		<state name="initState" type="simple" initial="true">
			<transition guard="true" targetState="dispatchState">
				<actions>
					<action type="operation" refName="PLInitAgreement"/>
					<action type="operation" refName="ClearDirtyFlagOp"/>
				</actions>					
			</transition> 
 		</state>
   			
		<state name="dispatchState" type="complex" activityName="chooseNodeActivity">	
			<transition event="root" targetState="rootViewState"/>
			<transition event="package" targetState="packageMainWindow"/>
			<transition event="program" targetState="programMainWindow"/>
 		</state>

		<state name="rootViewState" type="complex" page="app/agreement/jsp/agreementDetails.jsp" buttonSet="buildHeskemButtons">			
			<subFlowData flowName="tabsFlow"/>
			<entryActions>
				<action refName="resetTabModel" type="operation"></action>
			</entryActions>
			
			<transition event="agreementDetailsTreeModel|TreeEvent" targetState="dispatchState"/>
 		 
	 		<transition event="new" internal="true" >
				<subFlowData flowName="addPackageFlow"/>
			</transition>
  
			<transition event="delete" targetState="dispatchState" validator="checkDelete">
				<actions>
	            	<action type="operation" refName="PLDeletePackageOP" />
					<action type="operation" refName="SetDirtyFlagOp"/>
			    </actions>
			</transition>
			
			<transition event="save" internal="true" validator="claleyDetailsValidator">
				<actions>
	    	    	<action type="operation" refName="PLSaveAgreementOP"/>
					<action type="operation" refName="ClearDirtyFlagOp"/>
				</actions>
			</transition>
	
			<transition event="close" targetState="finalScreen"/>								  
 	
 	 		<transition event="finalScreen"  targetState="dispatchState"> 
 				<actions>
	 				<action type="operation" refName="PLAddPackageOP"/>
 				</actions>
	 		</transition> 	
	 		
	 		<transition event="customerLinkFinalState" targetState="openCustomer"/>
 	
 		</state>
	
		<state  type="complex" name="openCustomer">
			<subFlowData flowName="buildCustomerFlow" inFormatter="custIDFormmater"/>
			<entryActions>
				<action refName="checkExistance" type="operation" inFormatter="validateCustomerFormatter"/>
			</entryActions>	

			<transition event="finalScreen" targetState="rootViewState"/>
		</state>	




		<state name="packageMainWindow" type="complex" page="app/agreement/jsp/agreementDetails.jsp" buttonSet="buildHeskemButtons">			
			<subFlowData flowName="packageDetailFlow"/>
			<transition event="agreementDetailsTreeModel|TreeEvent" targetState="dispatchState" validator="packageValidator"/>
 		 
	 		<transition internal="true" event="new">
				<subFlowData flowName="addPackageFlow"/>
			</transition>
 
			<transition targetState="dispatchState" event="delete" validator="checkDelete">
				<actions>
	            	<action type="operation" refName="PLDeletePackageOP" />
					<action type="operation" refName="SetDirtyFlagOp"/>
			    </actions>
			</transition>
			
		<transition internal="true" event="save" validator="packageValidator">
			<actions>
	        	<action type="operation" refName="PLSaveAgreementOP" />
				<action type="operation" refName="ClearDirtyFlagOp"/>
			</actions>
		</transition>

		<transition event="close" targetState="finalScreen">		
		</transition>								  
 	
 		<transition event="finalScreen"  targetState="dispatchState"> 
 			<actions>
	 			<action type="operation" refName="PLAddPackageOP"/>
 			</actions>
 		</transition> 	
 	</state>
	
	<state name="programMainWindow" type="complex" page="app/agreement/jsp/agreementDetails.jsp" buttonSet="buildHeskemButtons">
		<subFlowData flowName="programDetail"/>
		<transition event="agreementDetailsTreeModel|TreeEvent" targetState="dispatchState"/>
 		 
	 	<transition internal="true" event="new">
			<subFlowData flowName="addPackageFlow"/>
		</transition>
  
		<transition targetState="dispatchState" event="delete" validator="checkDelete">
			<actions>
	        	<action type="operation" refName="PLDeletePackageOP" />
				<action type="operation" refName="SetDirtyFlagOp"/>
			</actions>
		</transition>
			
		<transition internal="true" event="save">
			<actions>
	        	<action type="operation" refName="PLSaveAgreementOP" />
				<action type="operation" refName="ClearDirtyFlagOp"/>
			</actions>
		</transition>

		<transition event="close" targetState="finalScreen"/>										  
 
  		<transition event="finalScreen"  targetState="dispatchState"> 
 			<actions>
	 			<action type="operation" refName="PLAddPackageOP"/>
 			</actions>
 		</transition> 	
 	</state>
				 		
 	<state name="finalScreen" type="final" />
 		 
 
 </flow>
 	

	<flow name="addPackageFlow" independent="true">
		<state name="init" type="complex" initial="true" page="app/agreement/jsp/chooseFromCatalog.jsp">
			<entryActions>
				<action refName="PLFillCatalogOP" type="operation"/>
			</entryActions>
			<transition event="ok" targetState="finalScreen"/>
			<transition event="catalogTableModel|dblSelection" targetState="finalScreen"/>
		</state>

		<state name="finalScreen" type="final"/>

	</flow>


 	<flow name="programDetail">
		<state name="init" type="complex" initial="true" page="app/agreement/jsp/programDetail.jsp">
			<entryActions>
				<action refName="PLInitProgramOP" type="operation"></action>
			</entryActions>
		</state>
	</flow>

	<flow name="packageDetailFlow">
		<state name="initState" type="complex" initial="true" page="app/agreement/jsp/packageDetail.jsp">
			<entryActions>
				<action refName="PLInitPackageOP" type="operation"></action>
			</entryActions>
		</state>
	</flow>
 		
	<!-- using type="tabSystem" whice let delete some attributes -->
	<flow name="tabsFlow" type="tabSystem">
		<tabSystemData page="app/common/jsp/HTabs.jsp"/>
		<state name="pirteyHeskemtabs_claleyHeskem" type="complex" initial="true" visible="true" >
			<subFlowData flowName="generalTabs"/>
			
			<transition event="customerLinkFinalState" targetState="customerLinkFinalState">
			</transition>
			
		</state>
			
		<state name="customerLinkFinalState" type="final"></state>
	
		<state name="pirteyHeskemtabs_meafyenim" type="complex" visible="true" page="app/agreement/jsp/meafyeniHeskem.jsp"/>
		
	</flow>
 
  	<flow name="generalTabs" type="tabSystem">
	  	<tabSystemData  page="app/agreement/jsp/generalTabs.jsp"/>

		<!-- navigator state. handling to which tab state we should move -->
		<!-- 1. to the first tab or to the tab which has the link-->
		<state name="dispatcher" type="complex" activityName="chooseTabActivity" initial="true">
			<transition event="generalTabsDetailsState" targetState="generalTabsDetailsState"/>
			<transition event="generalTabsDocumentsState" targetState="generalTabsDocumentsState"/>
			<transition event="generalTabsConfirmationState" targetState="generalTabsConfirmationState"/>
		</state>
	

		<state type="complex" name="generalTabsDetailsState" visible="true" page="app/agreement/jsp/claley_heskem_details.jsp">
			<entryActions>
				<action refName="PLInitGeneralTab" type="operation"/>
			</entryActions>
			
			<transition default="true" validator="claleyDetailsValidator" targetState="DISPATCHER"/>

			<transition event="searchCust" internal="true">
					<subFlowData flowName="searchCustomerFromAgreementFlow" inFormatter="customerFormatter"/>
		    </transition>

		<transition event="customerDetails" targetState="customerLinkFinalState">
			<actions>
				<action type="operation" refName="validateCustomer" inFormatter="validateCustomerFormatter"/>
			</actions> 
		</transition>
		
		
	<!--		<transition event="customerDetails" internal="true">
				<actions>
					<action type="operation" refName="validateCustomer" inFormatter="validateCustomerFormatter"/>
				</actions>
				<subFlowData flowName="subCustDetailsFlowWrapper" inFormatter="custIDFormmater"></subFlowData>		
		    </transition> -->

			<transition event="finalScreen" targetState="generalTabsDetailsState"></transition>
		</state>
			
		<state type="complex" name="generalTabsConfirmationState" visible="true" page="app/general/jsp/empty.jsp">	
		</state>
			
		<state type="complex" name="generalTabsDocumentsState" visible="true">
			<subFlowData flowName="documentsFlow"/>
			<transition event="customerLinkFinalState" targetState="customerLinkFinalState"/>
		</state>				
		
		<state name="customerLinkFinalState" type="final"/>

	</flow>
	

	<flow name="documentsFlow">
		<state name="InitState" type="simple" initial="true">
			<transition targetState="dispatchState" default="true">
				<actions>
			   		<action type="operation" refName="PLInitDocumentsOP"/>	
		<!--	   		<action type="operation" refName="ClearDirtyFlagOp"/> -->
			   	</actions>
			 </transition>				
		</state>

		<state name="dispatchState" type="simple">
			<transition targetState="ViewState"  default="true">
				<actions>
                    <action type="operation" refName="PLDocumentsLoadOP"/>
		        </actions> 
			</transition>
		</state>

		<state type="complex" name="ViewState" page="app/agreement/jsp/documents.jsp">
			<transition event="documentsTableModel|selection" targetState="dispatchState"/>
			<transition event="documentsTableModel|order" internal="true"/>	
			<transition event="documentsTableModel|sort" internal="true"/>	
	
			<transition event="new" internal="true">
				<subFlowData flowName="chooseDocumentFlow"></subFlowData>
			</transition>

			<transition event="update" targetState="dispatchState" validator="documentDetailsValidator">
					<actions>
	                    <action type="operation" refName="PLUpdateDocumentOP" />
			        </actions>
			</transition>
	
			<transition event="delete" targetState="dispatchState">
				<actions>
		            <action type="operation" refName="PLDeleteDocumentOP" />
					<action type="operation" refName="SetDirtyFlagOp"/>
			    </actions>
			</transition>
		
			<transition event="deleteAll" targetState="dispatchState">
				<actions>
		            <action type="operation" refName="PLDeleteAllDocumentOP" />
					<action type="operation" refName="SetDirtyFlagOp"/>
			    </actions>
			</transition>

			<transition event="okClick" targetState="dispatchState">
				<actions>
					<action refName="PLNewDocumentOP" type="operation"/>
				</actions> 			
			</transition> 				
		</state>			
	</flow>
	
	

<!--	<flow name="subCustDetailsFlowWrapper" context="pirteyCustomerContext" independent="true">
		<state initial="true" type="complex" name="s1" page="app/common/jsp/mainScreen.jsp">
			<subFlowData flowName="buildCustomerFlow" inFormatter="custIDFormmater"/>
			<entryActions>
				<action refName="checkExistance" type="operation" inFormatter="validateCustomerFormatter"/>
			</entryActions>		

			<transition event="finalScreen" targetState="finalScreen"/>
		</state>	
		
		<state name="finalScreen" type="final"></state>	
	</flow> -->

	<flow name="chooseDocumentFlow" independent="true">
		<state name="initPage" initial="true" type="complex" page="app/agreement/jsp/chooseDocument.jsp">
			<transition targetState="okClick" event="ok"/>
			<transition event="cancel" targetState="okClick" />
		</state>		
		<state name="okClick" type="final"/>		
	</flow>
</root>